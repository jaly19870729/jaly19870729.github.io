<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Developer iOS android" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta property="og:type" content="website">
<meta property="og:title" content="I'AM Developer">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="I'AM Developer">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="I'AM Developer">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> I'AM Developer </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  





  <script type="text/javascript">
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=60747891";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>






  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">I'AM Developer</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/untitled-1487149011198/" itemprop="url">
                  IOS 10 新特性以及介绍
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-15T16:56:51+08:00" content="2017-02-15">
              2017-02-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/15/untitled-1487149011198/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/15/untitled-1487149011198/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre>前言：iOS 10 发布有一段时间了，本次主要看看iOS 10 有哪些新的特性</pre>

<ul>
<li>Widget 可以在搜索界面、主屏可以看到</li>
<li>Message 可以添加自定义内容（类型微信表情），Message中添加自定义程序内容</li>
<li>SiriSDK开放 可以通过语音调取有特定功能的App内容</li>
<li>Notifications添加新的样式，可以实现预览</li>
</ul>
<p><strong>1.Today Widget 变更</strong></p>
<p> 主要是添加显示模式：</p>
<pre>
<code>
@property (nonatomic, assign) NCWidgetDisplayMode widgetLargestAvailableDisplayMode NS_AVAILABLE_IOS(10_0);</code>
<code>
@property (nonatomic, assign, readonly) NCWidgetDisplayMode widgetActiveDisplayMode NS_AVAILABLE_IOS(10_0);</code>
</pre>
<pre>
NCWidgetDisplayModeCompact:固定高度
NCWidgetDisplayModeExpanded:动态高度
</pre>
通过以下代码可以设置展开还是显示
<pre><code>self.extensionContext.widgetLargestAvailableDisplayMode = NCWidgetDisplayModeExpanded;</code></pre>

<p><strong>2.Message 变更</strong> (主要说明Message + App模式)</p>
<p>通过继承<code>MSMessagesAppViewController</code>，即可实现App<br>重点需要关注以下方法：</p>
<pre>
<code>
_//添加Message对象_
- (void)insertMessage:(MSMessage *)message completionHandler:(nullable void (^)(NSError * _Nullable))completionHandler;
_
_//添加Sticker对象_
- (void)insertSticker:(MSSticker *)sticker completionHandler:(nullable void (^)(NSError * _Nullable))completionHandler;
_
_//添加文本信息_
- (void)insertText:(NSString *)text completionHandler:(nullable void (^)(NSError * _Nullable))completionHandler;
_
_//添加附件_
- (void)insertAttachment:(NSURL *)URL withAlternateFilename:(nullable NSString *)filename completionHandler:(nullable void (^)(NSError * _Nullable))completionHandler;
</code>
</pre>

<p>构建消息体<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">- (MSMessage *)buildMessageWithItem:(Item *)item atIndexPath:(NSIndexPath *)indexPath&#123;</div><div class="line">    if (!self.activeConversation)&#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    MSSession *session = [[MSSession alloc]init];</div><div class="line">    if (self.activeConversation.selectedMessage.session)&#123;</div><div class="line">        session = self.activeConversation.selectedMessage.session;</div><div class="line">    &#125;</div><div class="line">    MSMessageTemplateLayout *layout = [[MSMessageTemplateLayout alloc]init];</div><div class="line">    layout.caption = [NSString stringWithFormat:@&quot;%@&quot;,item.caption];</div><div class="line">    layout.subcaption = [NSString stringWithFormat:@&quot;%@&quot;,item.subcaption];</div><div class="line">    layout.image = item.image;</div><div class="line">    MSMessage *message = [[MSMessage alloc]initWithSession:session];</div><div class="line">    message.URL = [NSURL URLWithString:item.url];</div><div class="line">    message.layout = layout;</div><div class="line">    return message;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<blockquote>
<p>说明:<code>MSMessageTemplateLayout</code>为Message消息体的布局模板</p>
</blockquote>
</blockquote>
<p><strong>SiriSDK</strong>（待更新）</p>
<p><strong>Notifications</strong>可以在通知中显示图片<br>主要是<code>UNNotificationServiceExtension</code>和<code>UNMutableNotificationContent</code>的配合使用<br>通过<code>UNNotificationServiceExtension</code>下载相应的图片<br>再通过<code>UNMutableNotificationContent</code>展示对应的图片</p>
<p>#未完待续</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/untitled-1487148955151/" itemprop="url">
                  IOS 10 新特性以及介绍-Notifications
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-15T16:55:55+08:00" content="2017-02-15">
              2017-02-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/15/untitled-1487148955151/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/15/untitled-1487148955151/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <pre>[上一篇](http://www.jianshu.com/p/726dda37a94e)中讲到Message中的一些特性，本次主要讲下Notification的特性</pre>

<p>iOS10相对于之前的版本，主要是开发者可以使用Extension的形式修改和展示内容，主要是<code>UNNotificationServiceExtension</code>和<code>UNNotificationContentExtension</code>。同时也添加了其他方面的支持，例如<code>UNNotificationTrigger</code>、<code>UNNotificationAttachment</code>、<code>UNNotificationAction</code>。本次讲的主要有以下几点:</p>
<ul>
<li>UNNotificationTrigger（通知触发条件设定）</li>
<li>UNNotificationAttachment （通知附件）</li>
<li>UNNotificationContentExtension （通知内容扩展）</li>
<li>UNNotificationServiceExtension （通知服务扩展）</li>
<li>UNNotificationAction （通知响应事件）</li>
</ul>
<p>##1、UNNotificationTrigger（通知触发条件设定）<br>主要是针对本地通知触发时机的设置，可以使用下面方式设置:</p>
<ol>
<li>UNPushNotificationTrigger:这个是苹果通知服务的 Trigger，对外没有暴露任何接口属性，不需要开发者创建，由系统创建。</li>
<li>UNTimeIntervalNotificationTrigger(时间触发器):通过初始化方法设置通知的timeInterval（触发间隔）<br>和repeats（是否重复触发），若 repeats 设置为 false，通知将在 timeInterval 之后被推送。</li>
<li>UNCalendarNotificationTrigger(日期触发器):类似 UNTimeIntervalNotificationTrigger，也是时间触发器，只不过初始化时第一个参数为 DateComponents类型，可设置具体的触发时间比如8:00 AM等，也可设置是否重复触发。</li>
<li>UNLocationNotificationTrigger(位置触发器):通过设置 CLRegion类型参数设置位置信息，当用户处于某一区域时，自动推送通知。</li>
</ol>
<p>使用:<br>  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">//设置Notification内容</div><div class="line">    UNMutableNotificationContent* content = [[UNMutableNotificationContent alloc] init];</div><div class="line">    content.title = [NSString localizedUserNotificationStringForKey:@&quot;title!&quot; arguments:nil];</div><div class="line">    content.body = [NSString localizedUserNotificationStringForKey:@&quot;body&quot; arguments:nil];</div><div class="line">    content.subtitle = [NSString localizedUserNotificationStringForKey:@&quot;subtitle&quot; arguments:nil];</div><div class="line">    content.sound = [UNNotificationSound defaultSound];</div><div class="line">    </div><div class="line">    //初始化时间触发器</div><div class="line">    UNTimeIntervalNotificationTrigger* trigger = [UNTimeIntervalNotificationTrigger triggerWithTimeInterval:10 repeats:NO];</div><div class="line">    UNNotificationRequest* request = [UNNotificationRequest requestWithIdentifier:@&quot;Identifier&quot;</div><div class="line">                                                                          content:content</div><div class="line">                                                                          trigger:trigger];</div><div class="line">    </div><div class="line">    // 请求计划推送</div><div class="line">    [[UNUserNotificationCenter currentNotificationCenter] addNotificationRequest:request withCompletionHandler:^(NSError * _Nullable error) &#123;</div><div class="line">        if(error)</div><div class="line">        &#123;</div><div class="line">            NSLog(@&quot;%@&quot;,error);</div><div class="line">        &#125;</div><div class="line">    &#125;];</div></pre></td></tr></table></figure></p>
<p>##2、UNNotificationAttachment（通知附件）<br>苹果所支持的推送附件类型包含视频，音频，图片，苹果的文档中对文件的类型和大小做了如下限制：<a href="https://developer.apple.com/reference/usernotifications/unnotificationattachment" target="_blank" rel="external">传送门</a><br>使用说明：</p>
<ul>
<li><p>本地通知：</p>
<blockquote>
<p>设置<code>UNMutableNotificationContent</code>如下属性</p>
<blockquote>
 <figure class="highlight plain"><figcaption><span>Optional array of attachments.</span></figcaption><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (NS_NONATOMIC_IOSONLY, copy) NSArray &lt;UNNotificationAttachment *&gt; *attachments</div></pre></td></tr></table></figure>
</blockquote>
</blockquote>
</li>
<li><p>远程通知:</p>
<blockquote>
<p>通过URL地址下载资源，然后将资源设置到<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">&gt;&gt; 示例代码: </div><div class="line"></div><div class="line"></div><div class="line"> ``` </div><div class="line">- (void)handlerImageWith:(NSString *)attachUrl&#123;</div><div class="line">    </div><div class="line">    [self downloadFileAndSave:[NSURL URLWithString:attachUrl] handler:^(NSURL *localUrl) &#123;</div><div class="line">        if (localUrl)&#123;</div><div class="line">            UNNotificationAttachment *attachment = [UNNotificationAttachment attachmentWithIdentifier:@&quot;image_download&quot; URL:localUrl options:nil error:nil];</div><div class="line">            self.bestAttemptContent.attachments = @[attachment];</div><div class="line">        &#125;</div><div class="line">        self.contentHandler(self.bestAttemptContent);</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)downloadFileAndSave:(NSURL *)url handler:(void (^)(NSURL *))handler&#123;</div><div class="line">    NSURLSession *session = [NSURLSession sharedSession];</div><div class="line">    </div><div class="line">    NSURLSessionDownloadTask *downloadTask = [session downloadTaskWithURL:url</div><div class="line">                                                        completionHandler:^(NSURL * _Nullable location,</div><div class="line">                                                                            NSURLResponse * _Nullable response,</div><div class="line">                                                                            NSError * _Nullable error) &#123;</div><div class="line">                                                            NSURL *localURL = nil;</div><div class="line">                                                            if(!error)&#123;</div><div class="line">                                                                NSString *caches = [NSSearchPathForDirectoriesInDomains(NSCachesDirectory, NSUserDomainMask, YES) lastObject];</div><div class="line">                                                                // response.suggestedFilename ： 建议使用的文件名，一般跟服务器端的文件名一致</div><div class="line">                                                                NSString *file = [caches stringByAppendingPathComponent:response.suggestedFilename];</div><div class="line">                                                                </div><div class="line">                                                                // 将临时文件剪切或者复制Caches文件夹</div><div class="line">                                                                NSFileManager *mgr = [NSFileManager defaultManager];</div><div class="line">                                                                </div><div class="line">                                                                // AtPath : 剪切前的文件路径</div><div class="line">                                                                // ToPath : 剪切后的文件路径</div><div class="line">                                                                [mgr moveItemAtPath:location.path toPath:file error:nil];</div><div class="line">                                                                </div><div class="line">                                                                if (file &amp;&amp; ![file  isEqualToString: @&quot;&quot;])</div><div class="line">                                                                &#123;</div><div class="line">                                                                    localURL = [NSURL URLWithString:[@&quot;file://&quot; stringByAppendingString:file]];</div><div class="line">                                                                &#125;</div><div class="line">                                                            &#125;</div><div class="line">                                                            handler(localURL);</div><div class="line">                                                        &#125;];</div><div class="line">    [downloadTask resume];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
</li>
</ul>
<p>注意事项:</p>
<ul>
<li>UNNotificationContent 的 attachments虽然是一个数组，但是系统只会展示第一个 attachment 对象的内容。不过你依然可以发送多个 attachments，然后在要展示的时候再重新安排它们的顺序，以显示最符合情景的图片或者视频。另外，你也可能会在自定义通知展示 UI 时用到多个 attachment。</li>
<li>在当前 beta (iOS 10 beta 4) 中，serviceExtensionTimeWillExpire被调用之前，你有 30 秒时间来处理和更改通知内容。对于一般的图片来说，这个时间是足够的。但是如果你推送的是体积较大的视频内容，用户又恰巧处在糟糕的网络环境的话，很有可能无法及时下载完成。</li>
<li>如果你想在远程推送来的通知中显示应用 bundle 内的资源的话，要注意 extension 的 bundle 和 app main bundle 并不是一回事儿。你可以选择将图片资源放到 extension bundle 中，也可以选择放在 main bundle 里。总之，你需要保证能够获取到正确的，并且你具有读取权限的 url。关于从 extension 中访问 main bundle，可以参看<a href="http://stackoverflow.com/questions/26189060/get-the-main-app-bundle-from-within-extension" target="_blank" rel="external">这篇回答</a>。</li>
<li>系统在创建 attachement 时会根据提供的 url 后缀确定文件类型，如果没有后缀，或者后缀无法不正确的话，你可以在创建时通过 UNNotificationAttachmentOptionsTypeHintKey<br>来<a href="https://developer.apple.com/reference/usernotifications/unnotificationattachmentoptionstypehintkey" target="_blank" rel="external">指定资源类型</a>。</li>
<li>如果使用的图片和视频文件不在你的 bundle 内部，它们将被移动到系统的负责通知的文件夹下，然后在当通知被移除后删除。如果媒体文件在 bundle 内部，它们将被复制到通知文件夹下。每个应用能使用的媒体文件的文件大小总和是有限制，超过限制后创建 attachment 时将抛出异常。可能的所有错误可以在 UNError中找到。</li>
<li>你可以访问一个已经创建的 attachment 的内容，但是要注意权限问题。可以使用 startAccessingSecurityScopedResource来暂时获取以创建的 attachment 的访问权限。比如：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">if(notification.request.content.attachments &amp;&amp; notification.request.content.attachments.count &gt; 0)&#123;</div><div class="line">        NSURL *imageUrl = notification.request.content.attachments[0].URL;</div><div class="line">        if([imageUrl startAccessingSecurityScopedResource])&#123;</div><div class="line">            NSData *imageData = [NSData dataWithContentsOfURL:imageUrl];</div><div class="line">            UIImage *image = [[UIImage alloc] initWithData:imageData];</div><div class="line">            self.imageView.image = image;</div><div class="line">            [imageUrl stopAccessingSecurityScopedResource];</div><div class="line">        &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>##3、UNNotificationContentExtension（通知内容扩展）<br>通知内容扩展需要新建一个 UNNotificationContentExtension Target，之后只需在 viewcontroller 的中实现相应的接口，即可以对 app 的通知页面进行自定义扩展，扩展主要用于自定义 UI。扩展页面样式可以在 plist 中配置，字段说明如下:</p>
<ul>
<li>UNNotificationExtensionCategory: 要让通知支持内容扩展，需要将通知的 categoryIdentifier（类型标示） 加入此处。</li>
<li>UNNotificationExtensionDefaultContentHidden: 默认内容隐藏，如果设为 YES，则最下面通知 content 部分会隐藏。</li>
<li>UNNotificationExtensionIntialContentSizeRation: 初始内容 Size 的比例。也可以在 viewDidLoad 中使用 self.preferredContentSize 直接设置 Size。</li>
</ul>
<p>使用说明:<br>远程和本地通知最终都可以使用此扩展自定义 UI，只需将通知的 categoryIdentifier（类型标示） 加入到 plist 中即可。</p>
<ul>
<li>本地推送时，确保设置的 content.categoryIdentifier（通知内容类型标示） 已加入 plist 中。</li>
<li>远程推送，需要设置 category 字段，且确保值也已加入 plist 中。</li>
</ul>
<p>##4、UNNotificationServiceExtension （通知服务扩展）<br>UNNotificationServiceExtension 提供在远程推送将要被 push 出来前，处理推送显示内容的机会。此时可以对通知的 request.content 进行内容添加，如添加附件，userInfo 等。服务器推送实例:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;aps&quot; : &#123;</div><div class="line">    &quot;alert&quot; : &#123;</div><div class="line">      &quot;title&quot; : &quot;title&quot;,</div><div class="line">      &quot;body&quot; : &quot;Your message Here&quot;      </div><div class="line">    &#125;,</div><div class="line">     // 开启可变内容</div><div class="line">    &quot;mutable-content&quot; : &quot;1&quot;,   </div><div class="line">    // 加入自定义数据，图片 url 路径</div><div class="line">    &quot;image&quot;:&quot;http://....jpg&quot;               </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>示例代码:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">- (void)didReceiveNotificationRequest:(UNNotificationRequest *)request withContentHandler:(void (^)(UNNotificationContent * _Nonnull))contentHandler &#123;</div><div class="line">    self.contentHandler = contentHandler;</div><div class="line">    self.bestAttemptContent = [request.content mutableCopy];</div><div class="line">    NSDictionary *apsDic = [request.content.userInfo objectForKey:@&quot;aps&quot;];</div><div class="line">    NSString *attachUrl = [apsDic objectForKey:@&quot;image&quot;];</div><div class="line">    if(attachUrl)&#123;</div><div class="line">        [self handlerImageWith:attachUrl];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>##5、UNNotificationAction（通知响应事件）<br>代表一个响应通知的事件。可以为每个通知设置不同的交互事件。下拉推送通知或处在锁屏界面侧滑通知时，会出现交互按键。<br>交互事件主要分为以下两类：</p>
<ul>
<li><strong>UNNotificationAction：</strong><br>普通点击按键，可设置 identifier、 title 及 点击后的响应，例如：foreground 前台响应，destructive 点击后销毁通知，authenticationRequired 响应前是否需要解锁。甚至可以使用 UNNotificationAction + accessoryInputView 结合，达到加入自定义辅助输入控件的效果</li>
<li><strong>UNTextInputNotificationAction：</strong><br>当然也可以直接使用系统类 UNTextInputNotificationAction 创建输入框，但是风格比较固定。</li>
</ul>
<p>示例代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)registerNotificationCategory&#123;</div><div class="line">    UNTextInputNotificationAction *inputAction = [UNTextInputNotificationAction actionWithIdentifier:@&quot;action_reply&quot; title:@&quot;回复&quot; options:UNNotificationActionOptionForeground];</div><div class="line">    UNNotificationAction *cancelAction = [UNNotificationAction actionWithIdentifier:@&quot;action_cancel&quot; title:@&quot;取消&quot; options:UNNotificationActionOptionDestructive];</div><div class="line">    </div><div class="line">    UNNotificationCategory *saySomething = [UNNotificationCategory categoryWithIdentifier:saySomethingCategory actions:@[inputAction,cancelAction] intentIdentifiers:@[] options:UNNotificationCategoryOptionCustomDismissAction];</div><div class="line">    [[UNUserNotificationCenter currentNotificationCenter] setNotificationCategories:[NSSet setWithObject:saySomething]];</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>响应处理：</strong></p>
<ul>
<li>若处于 UNNotificationContentExtension 通知扩展界面时，点击 【回复】按键会回调 UNNotificationContentExtension 扩展接口的方法：</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">// If implemented, the method will be called when the user taps on one</div><div class="line">// of the notification actions. The completion handler can be called</div><div class="line">// after handling the action to dismiss the notification and forward the</div><div class="line">// action to the app if necessary.</div><div class="line">- (void)didReceiveNotificationResponse:(UNNotificationResponse *)response completionHandler:(void (^)(UNNotificationContentExtensionResponseOption option))completion;&#123;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>如果不支持 UNNotificationContentExtension则点击【回复】回调 UNUserNotificationCenterDelegate 中的方法:</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// The method will be called on the delegate when the user responded to the notification by opening the application, dismissing the notification or choosing a UNNotificationAction. The delegate must be set before the application returns from applicationDidFinishLaunching:.</div><div class="line">- (void)userNotificationCenter:(UNUserNotificationCenter *)center didReceiveNotificationResponse:(UNNotificationResponse *)response withCompletionHandler:(void(^)())completionHandler&#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>补充：iOS10中可以在前台中收到通知了，需要添加一下代码:</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">\\ notificationHandler实现UNUserNotificationCenterDelegate</div><div class="line">[[UNUserNotificationCenter currentNotificationCenter] setDelegate:self.notificationHandler];</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/untitled-1487148938673/" itemprop="url">
                  iOS感应器之加速度计和陀螺仪(CoreMotion)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-15T16:55:38+08:00" content="2017-02-15">
              2017-02-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/15/untitled-1487148938673/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/15/untitled-1487148938673/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>前言：之前参加了一个比赛，里面主要涉及到VR图片拍摄和图片3D呈现，本次主要说说图片拍摄中使用到的陀螺仪和加速度计。</p>
</blockquote>
<h2 id="1、什么是CoreMotion"><a href="#1、什么是CoreMotion" class="headerlink" title="1、什么是CoreMotion"></a>1、什么是CoreMotion</h2><p>CoreMotion是一个专门处理Motion的框架，其中包含了两个部分加速度计和陀螺仪，在iOS4之前加速度计是由UIAccelerometer类来负责采集数据，现在一般都是用CoreMotion来处理加速度过程，不过由于UIAccelerometer比较简单，同样有人在使用。加速计由三个坐标轴决定，用户最常见的操作设备的动作移动，晃动手机(摇一摇)，倾斜手机都可以被设备检测到，加速计可以检测到线性的变化，陀螺仪可以更好的检测到偏转的动作，可以根据用户的动作做出相应的动作，iOS模拟器无法模拟以上动作，真机调试需要开发者账号。</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1459528-96c8d31d6f8b4266.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<p>##2、CoreMotion作用<br>CoreMotion主要负责三种数据：加速度值，陀螺仪值，设备motion值。实际上，这个设备motion值就是通过加速度和旋转速度进行 fusing变换算出来的，基本原理后面会介绍。CoreMotion在系统中以单独的后台线程的方式去获得原始数据，并同时执行一些motion算法来提取更多的信息，然后呈献给应用层做进一步处理。CoreMotion框架包含有一个专门的Manager类，CMMotionManager，然后由这个manager去管理三种和运动相关的数据封装类，而 且，这些类都是CMLogItem类的子类，所以相关的motion数据都可以和发生的时间信息一起保存到对应文件中，有了时间戳，两个相邻数据之间的实 际更新时间就很容易得到了。这个东西是非常有用的，比如有些时候，你得到的是50Hz的采样数据，但希望知道的是每一秒加速度的平均值。</p>
<p>##3、CoreMotion数据获取<br>CoreMotion中获取数据主要是两种方式:</p>
<ul>
<li>一种是Push，就是你提供一个线程管理器NSOperationQueue，再提供一个Block，这样，CoreMotion自动在每一个采样数据到来的时候回调这个Block，进行处理。在这中情况下，block中的操作会在你自己的主线程内执行。</li>
</ul>
<ul>
<li>一种是 Pull，在这个方式里，你必须主动去像CMMotionManager要数据，这个数据就是最近一次的采样数据。你不去要，CMMotionManager就不会给你。当然，在这种情况下，CoreMotion所有的操作都在自己的后台线程中进行，不会有任何干扰你当前线程的行为。</li>
</ul>
<p>##4、加速计</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1459528-ac3801256ae6b74b.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<ul>
<li>Pull获取方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//判断加速计是否可用</div><div class="line">if ([_motionManager isAccelerometerAvailable]) &#123;    </div><div class="line">    // 设置加速计采样频率</div><div class="line">    [_motionManager setAccelerometerUpdateInterval:1 / 40.0];</div><div class="line">    [_motionManager startAccelerometerUpdates];</div><div class="line">&#125;else &#123;</div><div class="line">    NSLog(@&quot;设备不支持加速计&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//获取数据</div><div class="line">CMAcceleration acceleration=_motionManager.accelerometerData.acceleration;</div><div class="line">NSLog(@&quot;%f---%f---%f&quot;,acceleration.x,acceleration.y,acceleration.z);</div></pre></td></tr></table></figure>
<ul>
<li>Push获取方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//判断加速计是否可用</div><div class="line">if([_motionManager isAccelerometerAvailable]) &#123;</div><div class="line">    // 设置加速计频率</div><div class="line">    [_motionManager setAccelerometerUpdateInterval:1 / 40.0];</div><div class="line">    //开始采样数据</div><div class="line">    [_motionManager startAccelerometerUpdatesToQueue:[NSOperationQueue mainQueue] withHandler:^(CMAccelerometerData *accelerometerData, NSError *error) &#123;</div><div class="line">        NSLog(@&quot;%f---%f&quot;,accelerometerData.acceleration.x,accelerometerData.acceleration.y);</div><div class="line">    &#125;];</div><div class="line">&#125; else&#123;</div><div class="line">    NSLog(@&quot;设备不支持加速计&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>##5、陀螺仪</p>
<p><img src="http://upload-images.jianshu.io/upload_images/1459528-5a5b094cd6a39871.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p>
<ul>
<li>Pull获取方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//判断陀螺仪是否可用</div><div class="line">if ([_motionManager isGyroAvailable]) &#123;    </div><div class="line">    // 设置陀螺仪采样频率</div><div class="line">    [_motionManager setGyroUpdateInterval:1 / 40.0];</div><div class="line">    [_motionManager startGyroUpdates];</div><div class="line">&#125;else &#123;</div><div class="line">    NSLog(@&quot;设备不支持陀螺仪&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//获取数据</div><div class="line">CMGyroData *gyroData=_motionManager.gyroData;</div><div class="line">NSLog(@&quot;%f---%f---%f&quot;,gyroData.rotationRate.x,gyroData.rotationRate.y,gyroData/rotationRate.z);</div></pre></td></tr></table></figure>
<ul>
<li>Push获取方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//判断陀螺仪是否可用</div><div class="line">if([_motionManager isGyroAvailable]) &#123;</div><div class="line">    // 设置陀螺仪频率</div><div class="line">    [_motionManager setGyroUpdateInterval:1 / 40.0];</div><div class="line">    //开始采样数据</div><div class="line">    [_motionManager startGyroUpdatesToQueue:[NSOperationQueue mainQueue] withHandler:^(CMGyroData *gyroData, NSError *error) &#123;</div><div class="line">        NSLog(@&quot;%f---%f---%f&quot;,gyroData.rotationRate.x,gyroData.rotationRate.y,gyroData/rotationRate.z);</div><div class="line">    &#125;];</div><div class="line">&#125; else&#123;</div><div class="line">    NSLog(@&quot;设备不支持陀螺仪&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/untitled-1487148892347/" itemprop="url">
                  IOS浏览控件之WKWebView
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-15T16:54:52+08:00" content="2017-02-15">
              2017-02-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/15/untitled-1487148892347/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/15/untitled-1487148892347/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<blockquote>
<p>WkWebView是IOS8中引入的新组件，苹果将UIWebViewDelegate 与 UIWebView 重构成了 14 个类和 3 个协议并引入了不少新的功能和接口。由于一直以来苹果对于WebView内核封锁的程度是令人发指的，WkWebView的引入无疑是另广大开发者兴奋的事</p>
</blockquote>
</blockquote>
<p>##1、WKWebView介绍<br>WKWebView是现代 WebKit API 在 iOS 8 和 OS X Yosemite 应用中的核心部分。它代替了 UIKit 中的UIWebView和 AppKit 中的WebView，提供了统一的跨双平台 API（iOS和OS）。</p>
<p>##2、WKWebView新特性</p>
<ol>
<li>在性能、稳定性、功能方面有很大提升（最直观的体现就是加载网页是占用的内存，模拟器加载百度与开源中国网站时，WKWebView占用23M，而UIWebView占用85M）</li>
<li>和 Safari 相同的 JavaScript 引擎，允许JavaScript的Nitro库加载并使用（UIWebView中限制）；</li>
<li>支持了更多的HTML5特性；</li>
<li>自诩拥有 60fps 滚动刷新率、内置手势、高效的 app 和 web 信息交换通道</li>
</ol>
<p>##3、WKWebView使用</p>
<ul>
<li><p>在WKWebView，一般都是使用UIWebView，而UIWebView的问题主要有：</p>
<ul>
<li>内存占用大</li>
<li>效率低</li>
<li>与JS交互比较麻烦</li>
<li>可扩展性低等</li>
</ul>
</li>
<li><p>使用WKWebView可以有效地解决上述问题。<br>示例:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// 创建webview</div><div class="line">WKWebView *webView = [[WKWebView alloc] initWithFrame:self.view.bounds];</div><div class="line">// 创建请求</div><div class="line">NSURLRequest *request =[NSURLRequest requestWithURL:[NSURL URLWithString:@&quot;http://www.baidu.com&quot;]];</div><div class="line">// 加载网页</div><div class="line">[webView loadRequest:request];</div><div class="line">// 将webView添加到界面</div><div class="line">[self.view addSubview:webView];</div></pre></td></tr></table></figure>
</li>
<li><p>WKWebView操作JS</p>
<ul>
<li><p>WKWebView加载JS</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//JS文件路径</div><div class="line">    NSString *jsPath = [[NSBundle mainBundle] pathForResource:@&quot;demo&quot; ofType:@&quot;js&quot;];</div><div class="line">    //读取JS文件内容</div><div class="line">    NSString *jsContent = [NSString stringWithContentsOfFile:jsPath encoding:NSUTF8StringEncoding error:nil];</div><div class="line">    //创建用户脚本对象，</div><div class="line">    //WKUserScriptInjectionTimeAtDocumentStart :HTML文档创建后，完成加载前注入，类似于&lt;head&gt;中</div><div class="line">    //WKUserScriptInjectionTimeAtDocumentEnd :HTML文件完成加载后注入,类似于&lt;body&gt;中</div><div class="line">    WKUserScript *script = [[WKUserScript alloc] initWithSource:jsContent injectionTime:WKUserScriptInjectionTimeAtDocumentStart forMainFrameOnly:YES];</div><div class="line">    //添加用户脚本</div><div class="line">    [webView.configuration.userContentController addUserScript:script];</div></pre></td></tr></table></figure>
</li>
<li><p>WKWebView执行JS方法</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">//执行JS方法</div><div class="line">    [webView evaluateJavaScript:@&quot;test()&quot; completionHandler:^(id _Nullable result, NSError * _Nullable error) &#123;</div><div class="line">        //result为执行js方法的返回值</div><div class="line">        if(error)&#123;</div><div class="line">            NSLog(@&quot;Success&quot;);</div><div class="line">        &#125;else&#123;</div><div class="line">            NSLog(@&quot;Fail&quot;);</div><div class="line">        &#125;</div><div class="line">    &#125;];</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>##4、WKWebView代理方法</p>
<ul>
<li><p>WKNavigationDelegate 协议</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">#pragma mark - WKNavigationDelegate</div><div class="line">// 页面开始加载时调用</div><div class="line">   - (void)webView:(WKWebView *)webView didStartProvisionalNavigation:(WKNavigation *)navigation &#123;</div><div class="line">&#125;</div><div class="line">// 内容开始返回时调用</div><div class="line">- (void)webView:(WKWebView *)webView didCommitNavigation:(WKNavigation *)navigation &#123;</div><div class="line">&#125;</div><div class="line">// 页面加载完成时调用</div><div class="line">- (void)webView:(WKWebView *)webView didFinishNavigation:(WKNavigation *)navigation &#123;</div><div class="line">&#125;</div><div class="line">// 页面加载失败时调用</div><div class="line">- (void)webView:(WKWebView *)webView didFailProvisionalNavigation:(WKNavigation *)navigation &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>新增的三个代理方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// 这个方法是服务器重定向时调用，即 接收到服务器跳转请求之后调用</div><div class="line">- (void)webView:(WKWebView *)webView didReceiveServerRedirectForProvisionalNavigation:(WKNavigation *)navigation &#123;</div><div class="line">&#125;</div><div class="line">// 在收到响应后，决定是否跳转</div><div class="line">- (void)webView:(WKWebView *)webView decidePolicyForNavigationResponse:(WKNavigationResponse *)navigationResponse decisionHandler:(void (^)(WKNavigationResponsePolicy))decisionHandler &#123;</div><div class="line">&#125;</div><div class="line">// 在发送请求之前，决定是否跳转</div><div class="line">- (void)webView:(WKWebView *)webView decidePolicyForNavigationAction:(WKNavigationAction *)navigationAction decisionHandler:(void (^)(WKNavigationActionPolicy))decisionHandler &#123;</div><div class="line">//需执行decisionHandler的block。</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>WKUIDelegate 协议</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">  #pragma mark - WKUIDelegate</div><div class="line">/// 创建一个新的WebView</div><div class="line">- (WKWebView *)webView:(WKWebView *)webView createWebViewWithConfiguration:(WKWebViewConfiguration *)configuration forNavigationAction:(WKNavigationAction *)navigationAction windowFeatures:(WKWindowFeatures *)windowFeatures &#123;</div><div class="line">    return nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/**</div><div class="line"> *  web界面中有弹出警告框时调用</div><div class="line"> *</div><div class="line"> *  @param webView           实现该代理的webview</div><div class="line"> *  @param message           警告框中的内容</div><div class="line"> *  @param frame             主窗口</div><div class="line"> *  @param completionHandler 警告框消失调用</div><div class="line"> */</div><div class="line">- (void)webView:(WKWebView *)webView runJavaScriptAlertPanelWithMessage:(NSString *)message initiatedByFrame:(void (^)())completionHandler &#123;</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">/// 输入框</div><div class="line">- (void)webView:(WKWebView *)webView runJavaScriptTextInputPanelWithPrompt:(NSString *)prompt defaultText:(nullable NSString *)defaultText initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(NSString * __nullable result))completionHandler &#123;</div><div class="line">    </div><div class="line">&#125;</div><div class="line">/// 确认框</div><div class="line">- (void)webView:(WKWebView *)webView runJavaScriptConfirmPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(BOOL result))completionHandler &#123;</div><div class="line">    </div><div class="line">&#125;</div><div class="line">/// 警告框</div><div class="line">- (void)webView:(WKWebView *)webView runJavaScriptAlertPanelWithMessage:(NSString *)message initiatedByFrame:(WKFrameInfo *)frame completionHandler:(void (^)(void))completionHandler &#123;</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>5、WKWebView疑难</p>
<ul>
<li><p>WKWebView加载POST请求无法发送参数问题</p>
<ol>
<li><p>使用NSURLSession发送一个请求，然后把请求下来的数据当作本地HTML加载</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">   // 创建WKWebView</div><div class="line">WKWebView *webView = [[WKWebView alloc] initWithFrame:[UIScreen mainScreen].bounds];</div><div class="line">// 将WKWebView添加到当前View</div><div class="line">[self.view addSubview:webView];</div><div class="line">// 设置访问的URL</div><div class="line">NSURL *url = [NSURL URLWithString:@&quot;http://www.example.com&quot;];</div><div class="line">// 根据URL创建请求</div><div class="line">NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:url];</div><div class="line">// 设置请求方法为POST</div><div class="line">[request setHTTPMethod:@&quot;POST&quot;];</div><div class="line">// 设置请求参数</div><div class="line">[request setHTTPBody:[@&quot;username=aaa&amp;password=123&quot; dataUsingEncoding:NSUTF8StringEncoding]];</div><div class="line"></div><div class="line">// 实例化网络会话</div><div class="line">NSURLSession *session = [NSURLSession sharedSession];</div><div class="line">// 创建请求Task</div><div class="line">NSURLSessionDataTask *task = [session dataTaskWithRequest:request completionHandler:^(NSData * _Nullable data, NSURLResponse * _Nullable response, NSError * _Nullable error) &#123;</div><div class="line">    </div><div class="line">    // 将请求到的网页数据用loadHTMLString 的方法加载</div><div class="line">    NSString *htmlStr = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];</div><div class="line">    [webView loadHTMLString:htmlStr baseURL:nil];</div><div class="line">&#125;];</div><div class="line">// 开启网络任务</div><div class="line">[task resume];</div></pre></td></tr></table></figure>
</li>
<li><p>使用JavaScript解决WKWebView无法发送POST参数问题(iOS8)</p>
</li>
</ol>
</li>
</ul>
<ul>
<li><p>iOS9以前版本读取本地HTML的问题<br>当使用loadRequest来读取本地的HTML时，WKWebView是无法读取成功的，后台会出现如下的提示：<br>  Could not create a sandbox extension for /<br>  原因是WKWebView是不允许通过loadRequest的方法来加载本地根目录的HTML文件。<br>  而在iOS9的SDK中加入了以下方法来加载本地的HTML文件：<br>  [WKWebView loadFileURL:allowingReadAccessToURL:]<br>  但是在iOS9以下的版本是没提供这个便利的方法的。以下为解决方案的思路，就是在iOS9以下版本时，先将本地HTML文件的数据copy到tmp目录中，然后再使用loadRequest来加载。但是如果在HTML中加入了其他资源文件，例如js，css，image等必须一同copy到temp中。这个是最蛋疼的事情了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">  //将文件copy到tmp目录</div><div class="line">- (NSURL *)fileURLForBuggyWKWebView8:(NSURL *)fileURL &#123;</div><div class="line">    NSError *error = nil;</div><div class="line">    if (!fileURL.fileURL || ![fileURL checkResourceIsReachableAndReturnError:&amp;error]) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    // Create &quot;/temp/www&quot; directory</div><div class="line">    NSFileManager *fileManager= [NSFileManager defaultManager];</div><div class="line">    NSURL *temDirURL = [[NSURL fileURLWithPath:NSTemporaryDirectory()] URLByAppendingPathComponent:@&quot;www&quot;];</div><div class="line">    [fileManager createDirectoryAtURL:temDirURL withIntermediateDirectories:YES attributes:nil error:&amp;error];</div><div class="line">    </div><div class="line">    NSURL *dstURL = [temDirURL URLByAppendingPathComponent:fileURL.lastPathComponent];</div><div class="line">    // Now copy given file to the temp directory</div><div class="line">    [fileManager removeItemAtURL:dstURL error:&amp;error];</div><div class="line">    [fileManager copyItemAtURL:fileURL toURL:dstURL error:&amp;error];</div><div class="line">    // Files in &quot;/temp/www&quot; load flawlesly :)</div><div class="line">    return dstURL;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//调用逻辑</div><div class="line">NSString *path = [[NSBundle mainBundle] pathForResource:@&quot;indexoff&quot; ofType:@&quot;html&quot;];</div><div class="line">if(path)&#123;</div><div class="line">    if ([[UIDevice currentDevice].systemVersion floatValue] &gt;= 9.0) &#123;</div><div class="line">        // iOS9. One year later things are OK.</div><div class="line">        NSURL *fileURL = [NSURL fileURLWithPath:path];</div><div class="line">        [self.webView loadFileURL:fileURL allowingReadAccessToURL:fileURL];</div><div class="line">    &#125; else &#123;</div><div class="line">        // iOS8. Things can be workaround-ed</div><div class="line">        //   Brave people can do just this</div><div class="line">        //   fileURL = try! pathForBuggyWKWebView8(fileURL)</div><div class="line">        //   webView.loadRequest(NSURLRequest(URL: fileURL))</div><div class="line">        </div><div class="line">        NSURL *fileURL = [self.fileHelper fileURLForBuggyWKWebView8:[NSURL fileURLWithPath:path]];</div><div class="line">        NSURLRequest *request = [NSURLRequest requestWithURL:fileURL];</div><div class="line">        [self.webView loadRequest:request];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>问题：<a href="http://stackoverflow.com/questions/24882834/wkwebview-not-loading-local-files-under-ios-8" target="_blank" rel="external">http://stackoverflow.com/questions/24882834/wkwebview-not-loading-local-files-under-ios-8</a><br>具体参见：<a href="https://github.com/shazron/WKWebViewFIleUrlTest" target="_blank" rel="external">https://github.com/shazron/WKWebViewFIleUrlTest</a></p>
<blockquote>
<p>ps:在实际测试中，上述方法在iOS8.0系统中也无法成功。如果在iOS8.0系统有成功的请告知下。谢谢！</p>
</blockquote>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/untitled-1487148858583/" itemprop="url">
                  iOS持续集成之自动更新设备
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-15T16:54:18+08:00" content="2017-02-15">
              2017-02-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/15/untitled-1487148858583/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/15/untitled-1487148858583/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<blockquote>
<p>在iOS开发中经常遇到的问题就是要添加测试设备。一般都需要登录开发者网站，操作比较麻烦。这里主要是通过脚本的形式添加设备</p>
</blockquote>
</blockquote>
<p> 这里主要用到的工具是fastlane中的spaceship，不熟悉的可以查看<a href="https://github.com/fastlane/fastlane" target="_blank" rel="external">这里</a></p>
<p>代码如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env ruby</div><div class="line"></div><div class="line">require &apos;rubygems&apos;</div><div class="line">require &apos;commander/import&apos;</div><div class="line">require &quot;spaceship&quot;</div><div class="line"></div><div class="line">global_option(&apos;-u&apos;, &apos;--username USER&apos;, &apos;Username&apos;) &#123; |arg| $username = arg unless arg.nil? &#125;</div><div class="line">global_option(&apos;-p&apos;, &apos;--password PASSWORD&apos;, &apos;Password&apos;) &#123; |arg| $password = arg unless arg.nil? &#125;</div><div class="line"></div><div class="line">program :name, &apos;app profile&apos;</div><div class="line">program :version, &apos;1.0.0&apos;</div><div class="line">program :description, &apos;证书 Create By Jay&apos;</div><div class="line"></div><div class="line"></div><div class="line">command :&apos;profiles:download:all&apos; do |c|</div><div class="line">  c.syntax = &apos;ios profiles:download:all&apos;</div><div class="line">  c.summary = &apos;Downloads all the active Provisioning Profiles&apos;</div><div class="line"></div><div class="line">  c.option &apos;--id  [ID]&apos;, &quot;&quot; ,&quot;程序包名&quot; </div><div class="line"></div><div class="line">  c.action do |args, options|</div><div class="line">    bundleId =  options.id</div><div class="line">    say &quot;开始登陆&quot; + bundleId</div><div class="line">    Spaceship.login($username, $password)</div><div class="line">    say &quot;登陆成功&quot; </div><div class="line">    say &quot;开始下载证书&quot;</div><div class="line">    profiles = Spaceship.provisioning_profile.find_by_bundle_id(bundleId)</div><div class="line">    profiles.each do |profile|</div><div class="line">    	say &quot;下载 &quot; + profile.name</div><div class="line">    	File.write(profile.name + &quot;.mobileprovision&quot;, profile.download)</div><div class="line">    end</div><div class="line">    say &quot;完成&quot;</div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">command :&apos;device:add:dict&apos; do |c|</div><div class="line">  c.syntax = &apos;aa device:add&apos;</div><div class="line">  c.summary = &apos;添加设备&apos;</div><div class="line">  c.option &apos;--dict [DICT]&apos;, &quot;&quot;, &quot;设备名称:udid键值对&quot;</div><div class="line">  c.option &apos;--id  [ID]&apos;, &quot;&quot; ,&quot;程序包名&quot; </div><div class="line">  c.action do |args,options|</div><div class="line">  	deviceDicts = eval(options.dict)</div><div class="line">  	bundleId =  options.id</div><div class="line">  	Spaceship.login($username, $password)</div><div class="line">  	if deviceDicts.class == Hash</div><div class="line">  		deviceName = deviceDicts[:name]</div><div class="line">  		deviceUDID = deviceDicts[:udid]</div><div class="line">  		registerDevice(deviceName,deviceUDID)</div><div class="line">		</div><div class="line">	elsif deviceDicts.class == Array</div><div class="line">        for dict in deviceDicts</div><div class="line">        	deviceName = deviceDicts[:name]</div><div class="line">  			deviceUDID = deviceDicts[:udid]</div><div class="line">  			registerDevice(deviceName,deviceUDID)</div><div class="line">        end</div><div class="line"></div><div class="line">	else</div><div class="line">		say &quot;格式不正确&quot;</div><div class="line">	end</div><div class="line">	say &quot;完成注册，更新profile&quot;	</div><div class="line">	say &quot;获取profiles&quot;</div><div class="line">  	profiles = Spaceship.provisioning_profile.find_by_bundle_id(bundleId)</div><div class="line">  	allDevices =  Spaceship.device.all</div><div class="line">  	say &quot;开始更新Profile中的Device&quot;</div><div class="line">  	profiles.each do |profile|</div><div class="line">    	say &quot;更新&quot; + profile.name + &quot;中的Device&quot;</div><div class="line">    	profile.devices = allDevices</div><div class="line">    	profile.update!</div><div class="line">    end</div><div class="line"></div><div class="line">  end</div><div class="line">end</div><div class="line"></div><div class="line">def registerDevice(deviceName,deviceUDID)</div><div class="line">	say &quot;注册设备：&quot; + deviceName + &quot;:&quot; + deviceUDID</div><div class="line">	Spaceship.device.create!(name: deviceName, udid: deviceUDID)</div><div class="line">end</div><div class="line"></div><div class="line"></div><div class="line">command :&apos;device:add&apos; do |c|</div><div class="line">  c.syntax = &apos;aa device:add&apos;</div><div class="line">  c.summary = &apos;添加设备&apos;</div><div class="line">  c.option &apos;--name [NAME]&apos;, &quot;&quot;, &quot;设备名称&quot;</div><div class="line">  c.option &apos;--udid  [UIID]&apos;, &quot;&quot; ,&quot;设备&quot; </div><div class="line">  c.option &apos;--id  [ID]&apos;, &quot;&quot; ,&quot;程序包名&quot; </div><div class="line">  c.action do |args,options|</div><div class="line">  	deviceName = options.name</div><div class="line">  	deviceUDID = options.udid</div><div class="line">  	bundleId = options.id</div><div class="line">  	say &quot;获取profiles&quot;</div><div class="line">  	profiles = Spaceship.provisioning_profile.find_by_bundle_id(bundleId)</div><div class="line">  	say &quot;注册Device&quot;</div><div class="line">  	Spaceship.device.create!(name: deviceName, udid: deviceUDID)</div><div class="line">  	allDevices =  Spaceship.device.all</div><div class="line">  	profiles.each do |profile|</div><div class="line">    	say profile.name</div><div class="line">    	profile.devices = allDevices</div><div class="line">    	profile.update!</div><div class="line">    end</div><div class="line">    say &quot;完成&quot;</div><div class="line">  end</div><div class="line">end</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/02/15/untitled-1487148728924/" itemprop="url">
                  iOS动态化之React Native
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2017-02-15T16:52:08+08:00" content="2017-02-15">
              2017-02-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2017/02/15/untitled-1487148728924/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2017/02/15/untitled-1487148728924/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <blockquote>
<p>近段时间来，关于移动客户端方面的动态化解决方案有了不少。之前的JSPatch，滴滴的解决方法：DynamicCocoa，微信iOS开发团队的解决方案：OCS。而今天需要说道的是React Native。</p>
</blockquote>
<h2 id="1-背景"><a href="#1-背景" class="headerlink" title="1. 背景"></a>1. 背景</h2><p>首先简单介绍下滴滴和微信的解决方案。</p>
<ul>
<li><p>1.1 DynamicCocoa<br><strong>DynamicCocoa</strong> 可以让现有的 Objective-C 代码转换生成中间*代码（JS），下发后动态执行，相比其他动态化方案，优势在于：</p>
<ul>
<li>使用原生技术栈：使用者完全不用接触到 JS 或任何中间代码，保持原生的 Objective-C 开发、调试方式不变</li>
<li>无需重写已有代码：已有 native 模块能很方便的变成动态化插件</li>
<li>语法支持完备性高：支持绝大多数日常开发中用到的语法，不用担心这不支持那不支持</li>
<li>支持 HotPatch<strong>：</strong>改完 bug 后直接从源码打出 patch，一站式解决动态化和热修复需</li>
</ul>
<p>最重要DynamicCocoa有一下特点：</p>
<ul>
<li><strong>完整的 Class 定义</strong>：interface、category、class extension、method、property，最重要的是支持完备的 ivar 定义，保持和 native 完全一致的实例内存结构</li>
<li><strong>ARC</strong>：可以正确处理 strong、weak、unsafe_unretained 等对象的引用计数，对象的 ivar 也可以正确的释放</li>
<li><strong>C 函数</strong>：支持 C 函数的定义与 C 函数的调用、内联函数的调用</li>
<li><strong>可变参数</strong>：支持 C 与 OC 的可变参数方法的调用，如 NSLog</li>
<li><strong>struct</strong>：支持任意结构体的使用，无需额外处理</li>
<li><strong>block</strong>：支持创建和调用任意参数类型的 block</li>
<li><strong>其他 OC 特性：</strong>如 @selector、@protocol、@encode、for..in 等</li>
<li><strong>其他 C 特性</strong>：支持使用宏、static 变量、全局变量，取地址等</li>
</ul>
<p>ps:<a href="http://mp.weixin.qq.com/s/qRW_akbU3TSd0SxpF3iQmQ" target="_blank" rel="external">DynamicCocoa完整介绍</a></p>
</li>
<li><p>1.2 OCS<br>OCS是全新设计的iOS动态化方案。我们定义了一套精确描述OC语义的字节码指令集(OCScript)，开发了一套全自动编译器（OCSCompiler），实现了一个高性能的虚拟机（OCSVM）以及一个可以跟底层无缝对接的桥接器(OCSBridge)。我们首先使用OCS编译器把OC源码转化成OCS字节码，然后通过OCS桥接器实现OCS虚拟机与Native运行时的互联，最后使用OCS虚拟机对OCS字节码进行解释运算，并驱动Native运行时完成逻辑的执行，以此达到Native代码动态化的效果。OCS被用于iOS APP安装包减包、功能插件化、HotPatch等方方面面动态化需求。</p>
<ul>
<li>OCS有哪些与众不同之处<ul>
<li>语义与OC保持严格一致<br>OCS字节码指令集语义与OC/的语义保持严格一一对应关系，支持的数据类型也完全等同，运行过程无需进行任何转换，因此效率非常高。</li>
<li>自动化工具支持<br>OCS拥有完善的自动化工具链，OCS编译器支持绝大多数OC/C语法的转化，包括C方法、任意自定义结构体、任意自定义block。对于少数不支持的的语法，可以准确报错，引导用户进行规避，避免产生未定义行为。OCS编译器还可以准确识别OC/C代码的内存管理语义，可以正确生成内存管理相关的代码。特别对于ARC来说，可以准确生成Retain、Release代码，正确插入到生成代码中去。</li>
<li>原生OC内存管理机制<br>OCS虚拟机完全支持Native的内存管理机制，可以在正确的时机执行正确的内存释放逻辑，绝无延迟操作，彻底杜绝了Crash和爆内存风险的引入。</li>
<li>抢占式多线程<br>OCS虚拟机支持Native的抢占式多线程线程管理支持，完全支持Pthread、 GCD、 NSOperationqueue、 NSThread等各种线程模型，完全避免了额外引入Crash、卡顿与死锁风险。</li>
<li>高性能汇编ABI<br>OCS桥接器根据过程调用约定实现自定义OCSABI，使得虚拟机与Native底层实现直接通信，保证Native代码动态化引入额外性能损耗最小化，使得OCS动态化不仅普遍适用于普通逻辑转化，对于对性能要求苛刻的有复杂排版的滑动列表，OCS也有极佳的表现，动态化后掉帧率增长量几乎可以忽略不计</li>
</ul>
</li>
</ul>
<p>ps:<a href="http://mp.weixin.qq.com/s/zctwM2Wf8c6_sxT_0yZvXg" target="_blank" rel="external">OCS完整介绍</a></p>
</li>
<li><p>1.3 ReactNative<br>React Native 让开发者使用 JavaScript 和 React 编写应用，利用相同的核心代码就可以创建 Web，iOS 和 Android 平台的原生应用。React Native 的宗旨是，学习一次，高效编写跨平台原生应用。</p>
<ul>
<li><p>React Native有什么优点</p>
<ul>
<li><strong>提供了原生的控件支持</strong><br>使用 React Native 你可以使用原生的控件，入在iOS平台我们可以使用UITabBar控件，在Android平台我们可以使用Drawer控件。这样，就让我们的App从使用上和视觉上拥有像原生App一样的体验。而且使用起来也非常简单。</li>
<li><p><strong>异步执行</strong><br>所有的JavaScript逻辑与原生的代码逻辑都是在异步中执行的。原生的代码逻辑当然也可以添加自己的额外的线程。<br>这个特性意味着，我们可以将图片解码过程的线程从主线程中抽离出来，在后台线程将其保存在磁盘中，在不影响UI的情况下计算调整布局等等。</p>
<blockquote>
<p>所以，这些让React Native开发出来的App都是较为的流畅。<br>这个之间的通信过程也是有序列化来完成的，这个就让我们可以使用Chrome Developer Tools 来完成JavaScript逻辑的调试，当然我们也能够在模拟器和物理设备上调试。</p>
</blockquote>
</li>
<li><p><strong>触屏处理</strong> React Native实现了高性能的图层点击与接触处理。</p>
</li>
<li><strong>Flexbox的布局样式</strong> 使布局将变得更简单，这就使我们为什么要将网页的布局模式切换到React Native的Flexbox布局模式。Flexbox让UI布局变得简单，入使用margin和padding的嵌套模式。当然，React Native 同样也支持网页原生的一些属性布局模式，如FontWeight之类的。这些声明的布局和样式，都会存在内联的机制将其优化。</li>
<li><strong>Polyfills机制</strong> React Native也支持我们使用第三方的JavaScript库，来方便我们的开发。支持npm中的成千上万的模块。</li>
<li><strong>基于React JS</strong> 拥有React JS的优良特性。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="2-抉择"><a href="#2-抉择" class="headerlink" title="2. 抉择"></a>2. 抉择</h2><p>通过上面的简单介绍，可以看出DynamicCocoa和OCS都还是很厉害的。对于iOS开发人员，可以不需要去花费过多的时间来学习其他语言，使用原生的Object-C也可以基本完成动态化。然后在实际开发中，以及实际的项目中，功能不仅仅是在iOS平台上面，同时在Android中也需要。这个时候就比较尴尬了。但是ReactNative却不一样，他是跨平台的，可以同时支持iOS和Android，同时可以达到原生的效果（虽然和其他两个的性能上还是有些差距），而且现在的手机性能都在不断提升，利弊权衡下，个人觉得ReactNative相对是更优选择。</p>
<h2 id="3-ReactNative应用"><a href="#3-ReactNative应用" class="headerlink" title="3. ReactNative应用"></a>3. ReactNative应用</h2><blockquote>
<p> 这里主要相对于现有工程</p>
</blockquote>
<ul>
<li><p>3.1 在现有工程中添加ReactNative<br>条件:</p>
<ul>
<li>1、CocoaPods</li>
<li>2、Node.js</li>
</ul>
<p>步骤:</p>
<ul>
<li>1、工程根目录下创建ReactComponent</li>
<li><p>2、在ReactComponent目录中创建JS文件（例如:index.ios.js），并初始化</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm init</div></pre></td></tr></table></figure>
</li>
<li><p>3、通过CocoaPods安装ReactNative库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">def react_native</div><div class="line">    # 取决于你的工程如何组织，你的node_modules文件夹可能会在别的地方。</div><div class="line">    # 请将:path后面的内容修改为正确的路径（一定要确保正确～～）。</div><div class="line">    pod &apos;React&apos;, :path =&gt; ‘./ReactComponent/node_modules/react-native&apos;, :subspecs =&gt; [</div><div class="line">    &apos;Core&apos;,</div><div class="line">    &apos;ART&apos;,</div><div class="line">    &apos;RCTActionSheet&apos;,</div><div class="line">    &apos;RCTAdSupport&apos;,</div><div class="line">    &apos;RCTGeolocation&apos;,</div><div class="line">    &apos;RCTImage&apos;,</div><div class="line">    &apos;RCTNetwork&apos;,</div><div class="line">    &apos;RCTPushNotification&apos;,</div><div class="line">    &apos;RCTSettings&apos;,</div><div class="line">    &apos;RCTText&apos;,</div><div class="line">    &apos;RCTVibration&apos;,</div><div class="line">    &apos;RCTWebSocket&apos;,</div><div class="line">    &apos;RCTLinkingIOS&apos;,</div><div class="line">    ]</div><div class="line">end</div></pre></td></tr></table></figure>
</li>
<li><p>4、执行CocoaPods</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pod install</div></pre></td></tr></table></figure>
</li>
<li><p>5、添加原生代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">NSString * strUrl = @&quot;http://127.0.0.1:8081/index.ios.bundle?platform=ios&amp;dev=true&quot;;</div><div class="line">    NSURL * jsCodeLocation = [NSURL URLWithString:strUrl];</div><div class="line">    </div><div class="line">    RCTRootView *rootView = [[RCTRootView alloc] initWithBundleURL:jsCodeLocation</div><div class="line">                                                        moduleName:@&quot;AwesomeProject&quot;</div><div class="line">                                                 initialProperties:nil</div><div class="line">                                                     launchOptions:nil];</div><div class="line">    self.view = rootView;</div></pre></td></tr></table></figure>
</li>
<li><p>6、运行react</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">npm start</div></pre></td></tr></table></figure>
</li>
<li><p>7、运行原生应用(Run)</p>
</li>
</ul>
</li>
</ul>
<h2 id="4-ReactNative发布"><a href="#4-ReactNative发布" class="headerlink" title="4. ReactNative发布"></a>4. ReactNative发布</h2><p>在技术上来讲当然可以把react程序放在服务器上，但是加载速度就比较慢，在用户体验上当然也会减分不少。因此可以通过打离线包(jsbundle)的方式,通过服务端控制来实现程序的动态化（类似JSPatch发布机制）。</p>
<ul>
<li><p>ReactNative离线打包<br>我们用‘react-native bundle’命令把JS代码打包成一个bundle文件。然后客户端直接访问这个bundle文件即可。</p>
<h5 id="命令说明"><a href="#命令说明" class="headerlink" title="命令说明"></a>命令说明</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">react-native bundle</div></pre></td></tr></table></figure>
</li>
</ul>
<p>Options:</p>
<table>
<thead>
<tr>
<th style="text-align:left">命令</th>
<th style="text-align:left">枚举</th>
<th style="text-align:left">解释 </th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left"> –entry-file</td>
<td style="text-align:left">index.ios.js</td>
<td style="text-align:left">入口文件</td>
</tr>
<tr>
<td style="text-align:left"> –platform</td>
<td style="text-align:left">“ios”/“android”</td>
<td style="text-align:left">平台</td>
</tr>
<tr>
<td style="text-align:left"> –transformer</td>
<td style="text-align:left">/packager/transformer.js</td>
<td style="text-align:left">transformer</td>
</tr>
<tr>
<td style="text-align:left"> –dev</td>
<td style="text-align:left">false /true</td>
<td style="text-align:left">调试开关</td>
</tr>
<tr>
<td style="text-align:left"> –prepack</td>
<td style="text-align:left">false/true</td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"> –bridge-config</td>
<td style="text-align:left"></td>
<td style="text-align:left"></td>
</tr>
<tr>
<td style="text-align:left"> –bundle-output</td>
<td style="text-align:left">路径</td>
<td style="text-align:left">bundle包目标路径</td>
</tr>
<tr>
<td style="text-align:left"> –assets-dest</td>
<td style="text-align:left">资源文件路径</td>
<td style="text-align:left">资源文件路径</td>
</tr>
</tbody>
</table>
<ul>
<li>修改原生代码<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">NSURL * jsCodeLocation = [[NSBundle mainBundle ] URLForResource:@&quot;main&quot; withExtension:@&quot;jsbundle&quot;];</div><div class="line">RCTRootView *rootView = [[RCTRootView alloc] initWithBundleURL:jsCodeLocation moduleName:@&quot;AwesomeProject&quot; initialProperties:nil launchOptions:nil];</div><div class="line">self.view = rootView;</div></pre></td></tr></table></figure></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  


          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="Developer Ops" />
          <p class="site-author-name" itemprop="name">Developer Ops</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">6</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Developer Ops</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.1"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"jaly19870729"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  

</body>
</html>
